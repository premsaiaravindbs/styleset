<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>StyleSet — Photo-based Style Recommender</title>
  <meta name="description" content="Upload a photo and get a style set. Works as a simple web page. Optional: call your own API endpoint." />
  <style>
    :root {
      --bg: #0b0f19;
      --card: #121826;
      --muted: #9aa4af;
      --text: #e6edf3;
      --accent: #66d9e8;
      --ok: #7ee787;
      --warn: #ffd166;
      --err: #ff6b6b;
      --radius: 14px;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: linear-gradient(180deg, #0b0f19, #101828 40%, #0b0f19);
      color: var(--text);
      min-height: 100vh;
      display: grid; place-items: start center;
    }
    .container {
      width: min(960px, 92vw);
      margin: 32px auto 80px;
    }
    header {
      display: flex; align-items: center; justify-content: space-between; gap: 16px; margin-bottom: 18px;
    }
    h1 { margin: 0; font-size: clamp(1.2rem, 4vw, 1.8rem); letter-spacing: .2px; }
    .tag { font-size: 12px; color: var(--muted); }
    .card {
      background: rgba(18,24,38,0.9); border: 1px solid rgba(255,255,255,0.06);
      border-radius: var(--radius); padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .grid {
      display: grid; grid-template-columns: 1fr; gap: 16px;
    }
    @media (min-width: 900px) {
      .grid { grid-template-columns: 1.1fr 1fr; }
    }
    .upload {
      border: 1.5px dashed rgba(255,255,255,0.18); border-radius: var(--radius);
      padding: 18px; display: grid; gap: 10px; align-content: center; justify-items: center; text-align: center;
    }
    .upload input[type="file"] { display:none; }
    .upload label {
      padding: 10px 14px; background: #0f172a; border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px; cursor: pointer; font-weight: 600;
    }
    .upload small { color: var(--muted); }
    .preview {
      display: grid; grid-template-columns: 1fr; gap: 10px; align-items: start;
    }
    .preview img {
      width: 100%; max-height: 420px; object-fit: contain; border-radius: 12px; background: #0f172a;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row > * { width: 100%; }
    .input, select, textarea {
      width: 100%; padding: 10px 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
      background: #0f172a; color: var(--text);
    }
    button {
      padding: 10px 14px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.08);
      background: var(--accent); color: #0b0f19; font-weight: 800; cursor: pointer;
    }
    button.secondary { background: #0f172a; color: var(--text); }
    .muted { color: var(--muted); font-size: 13px; }
    .pill { display:inline-block; padding: 6px 10px; border-radius: 999px; background: #0f172a; border: 1px solid rgba(255,255,255,0.08); margin: 3px 4px 0 0; font-size: 13px; }
    .status { font-size: 13px; }
    .status.ok { color: var(--ok); }
    .status.warn { color: var(--warn); }
    .status.err { color: var(--err); }
    .footer {
      margin-top: 16px; color: var(--muted); font-size: 12px; text-align: center;
    }
    .list { display: grid; gap: 8px; }
    .list .item { background: #0f172a; border-radius: 12px; padding: 10px 12px; border: 1px solid rgba(255,255,255,0.08); }
    .section-title { margin: 8px 0; font-size: 14px; letter-spacing: .2px; text-transform: uppercase; color: var(--muted); }
    .kbd { padding: 2px 6px; border-radius: 6px; background: #0b1220; border: 1px solid rgba(255,255,255,.1); font-size: 12px; }
    .link { color: var(--accent); text-decoration: underline; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div>
        <h1>StyleSet — Photo-based Style Recommender</h1>
        <div class="tag">No  Optional API integration</div>
      </div>
      <button id="resetBtn" class="secondary" title="Clear inputs">Reset</button>
    </header>

    <div class="grid">
      <!-- Left column: controls -->
      <div class="card">
        <div class="upload">
          <label for="file">Upload a photo</label>
          <input id="file" type="file" accept="image/*" />
          <small>PNG/JPG. Image stays in your browser.</small>
        </div>

        <div class="section-title">API (optional)</div>
        <div class="row">
          <input id="apiUrl" class="input" placeholder="API URL (multipart/form-data)" />
          <input id="apiKey" class="input" placeholder="API Key (if required)" />
        </div>
        <small class="muted">
          Tip: Paste your endpoint and key. Saved to your browser only. You can also set via URL, e.g. <span class="kbd">?apiUrl=https://example.com&apiKey=xyz</span>.
        </small>

        <div class="row" style="margin-top:10px;">
          <select id="mode" class="input" title="Choose how to analyze">
            <option value="api">Use API (https://styleset.premsaiaravind7.workers.dev/)</option>
            <option value="local">Local Analyzer (no API)</option>
            <option value="auto" selected>Auto: API then Local fallback</option>
          </select>
          <button id="analyzeBtn">Analyze</button>
        </div>
        <div id="status" class="status muted">Waiting for image…</div>
      </div>

      <!-- Right column: preview and results -->
      <div class="card">
        <div class="preview">
          <img id="preview" alt="Preview will appear here" />
          <canvas id="canvas" style="display:none;"></canvas>
        </div>

        <div class="section-title">Suggested Style Sets</div>
        <div id="styles" class="list"></div>

        <div class="section-title">Palette & Notes</div>
        <div id="meta" class="list"></div>
      </div>
    </div>

    <div class="footer">
      <div>Built as a single-file web app. Host via <a class="link" href="https://pages.github.com/" target="_blank" rel="noreferrer">GitHub Pages</a>.</div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const fileInput = $('file');
    const preview = $('preview');
    const canvas = $('canvas');
    const apiUrlEl = $('apiUrl');
    const apiKeyEl = $('apiKey');
    const statusEl = $('status');
    const stylesEl = $('styles');
    const metaEl = $('meta');
    const modeEl = $('mode');
    const resetBtn = $('resetBtn');
    const analyzeBtn = $('analyzeBtn');

    // --- State helpers
    function setStatus(msg, cls='muted') {
      statusEl.textContent = msg;
      statusEl.className = 'status ' + cls;
    }
    function savePrefs() {
      try {
        localStorage.setItem('styleset:apiUrl', apiUrlEl.value.trim());
        localStorage.setItem('styleset:apiKey', apiKeyEl.value.trim());
        localStorage.setItem('styleset:mode', modeEl.value);
      } catch {}
    }
    function loadPrefs() {
      try {
        const urlp = new URLSearchParams(location.search);
        const u = urlp.get('apiUrl'); const k = urlp.get('apiKey'); const m = urlp.get('mode');
        apiUrlEl.value = u ?? localStorage.getItem('styleset:apiUrl') ?? '';
        apiKeyEl.value = k ?? localStorage.getItem('styleset:apiKey') ?? '';
        modeEl.value = m ?? localStorage.getItem('styleset:mode') ?? 'auto';
      } catch {}
    }
    loadPrefs();

    // --- Image handling
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      preview.src = url;
      preview.onload = () => URL.revokeObjectURL(url);
      setStatus('Image loaded. Ready to analyze.', 'ok');
    });

    resetBtn.addEventListener('click', () => {
      fileInput.value = '';
      preview.src = '';
      stylesEl.innerHTML = '';
      metaEl.innerHTML = '';
      setStatus('Waiting for image…');
    });

    analyzeBtn.addEventListener('click', () => analyze().catch(err => {
      console.error(err); setStatus('Unexpected error. See console for details.', 'err');
    }));

    // --- Core analyze flow
    async function analyze() {
      savePrefs();
      const mode = modeEl.value;
      if (!preview.src) { setStatus('Please upload a photo first.', 'warn'); return; }

      setStatus('Analyzing…', 'muted');
      stylesEl.innerHTML = '';
      metaEl.innerHTML = '';

      let used = 'local';
      let result = null;

      if (mode !== 'local') {
        result = await tryApi(preview);
        if (result) used = 'api';
        else if (mode === 'api') {
          setStatus('API failed. Check URL/key and CORS.', 'err');
          return;
        }
      }

      if (!result) {
        result = await localAnalyze(preview);
      }

      renderResult(result, used);
    }

    // --- API attempt
    async function tryApi(imgEl) {
      const endpoint = apiUrlEl.value.trim();
      if (!endpoint) return null;

      try {
        const blob = await fetch(imgEl.src).then(r => r.blob());
        const fd = new FormData();
        fd.append('image', blob, 'photo.png');

        const headers = {};
        if (apiKeyEl.value.trim()) headers['Authorization'] = 'Bearer ' + apiKeyEl.value.trim();

        const res = await fetch(endpoint, { method: 'POST', body: fd, headers });
        if (!res.ok) throw new Error('API HTTP ' + res.status);
        const json = await res.json();

        // Expected JSON shape (example):
        // {
        //   "styles": ["Casual Minimalist", "Warm Autumn Palette"],
        //   "palette": ["#c58a6a","#3b4d61","#e9c46a"],
        //   "notes": "Detected warm undertone; earth tones recommended."
        // }
        const styles = Array.isArray(json.styles) ? json.styles : [];
        const palette = Array.isArray(json.palette) ? json.palette : [];
        const notes = typeof json.notes === 'string' ? json.notes : JSON.stringify(json);

        return { source: 'api', styles, palette, notes };
      } catch (e) {
        console.warn('API call failed:', e);
        return null;
      }
    }

    // --- Local analyzer (simple, deterministic)
    async function localAnalyze(imgEl) {
      // Downscale for speed
      const maxW = 256;
      const scale = Math.min(1, maxW / (imgEl.naturalWidth || 512));
      const w = Math.max(64, Math.floor((imgEl.naturalWidth || 256) * scale));
      const h = Math.max(64, Math.floor((imgEl.naturalHeight || 256) * scale));

      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(imgEl, 0, 0, w, h);
      const { data } = ctx.getImageData(0, 0, w, h);

      // Compute average RGB + simple dominant palette via sampling
      let r=0,g=0,b=0, n=0;
      const palette = new Map();
      const step = 8;
      for (let y=0; y<h; y+=step) {
        for (let x=0; x<w; x+=step) {
          const i = (y*w + x) * 4;
          const rr = data[i], gg = data[i+1], bb = data[i+2];
          r += rr; g += gg; b += bb; n++;
          const key = quantize(rr,gg,bb,24); // coarse bucket
          palette.set(key, (palette.get(key)||0)+1);
        }
      }
      const avg = [Math.round(r/n), Math.round(g/n), Math.round(b/n)];
      const hexAvg = rgbToHex(...avg);

      // Build a small suggested palette from top buckets
      const topColors = [...palette.entries()].sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k])=>k);
      const hexPalette = topColors.map(bucketToHex);

      const { tone, season } = inferToneAndSeason(avg);
      const styles = suggestStyles(season);

      const notes = `Local analysis detected ${tone} undertone → ${season} palette suggestion. Average color ${hexAvg}.`;

      return { source: 'local', styles, palette: [hexAvg, ...hexPalette], notes };
    }

    function quantize(r,g,b,q=24){
      const qr = Math.round(r/q)*q, qg = Math.round(g/q)*q, qb = Math.round(b/q)*q;
      return rgbToHex(qr,qg,qb);
    }
    function rgbToHex(r,g,b){
      return '#' + [r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
    }
    function bucketToHex(hex){ return hex; }

    function inferToneAndSeason([r,g,b]){
      // Simple warm/cool heuristic
      const warmScore = r - b + 0.5*(g - b);
      const tone = warmScore >= 0 ? 'warm' : 'cool';
      // Map to season
      // Warm → Spring/Autumn based on brightness; Cool → Summer/Winter
      const brightness = (0.2126*r + 0.7152*g + 0.0722*b)/255;
      let season = 'Autumn';
      if (tone === 'warm') season = brightness > 0.6 ? 'Spring' : 'Autumn';
      else season = brightness > 0.6 ? 'Summer' : 'Winter';
      return { tone, season };
    }

    function suggestStyles(season){
      const sets = {
        Spring: [
          'Light Neutrals + Pastels',
          'Smart-Casual (beige, sage, soft teal)',
          'Minimal Gold Accents',
          'Neutral Sneakers / Light Leather'
        ],
        Summer: [
          'Soft Cool Neutrals (slate, dove grey)',
          'Monochrome Layers',
          'Silver/Steel Accessories',
          'Textured Fabrics (linen, seersucker)'
        ],
        Autumn: [
          'Earth Tones (rust, olive, camel)',
          'Workwear Casual (denim, chore jackets)',
          'Matte Leather Accessories',
          'Boot-ready Layering'
        ],
        Winter: [
          'High-Contrast (black, charcoal, white)',
          'Clean Lines / Structured Fits',
          'Chrome/Black Accessories',
          'Performance Fabrics'
        ]
      };
      return sets[season] ?? ['Classic Essentials'];
    }

    function renderResult(result, used){
      const { styles, palette, notes } = result;
      setStatus(used === 'api' ? 'Finished via API.' : 'Finished via Local Analyzer.', used === 'api' ? 'ok' : 'warn');

      stylesEl.innerHTML = '';
      (styles||[]).forEach(s => {
        const div = document.createElement('div');
        div.className = 'item';
        div.textContent = s;
        stylesEl.appendChild(div);
      });

      metaEl.innerHTML = '';
      const pal = document.createElement('div');
      pal.className = 'item';
      pal.innerHTML = '<div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">'
        + (palette||[]).slice(0,6).map(hex => `<span class="pill"><span style="display:inline-block;width:12px;height:12px;border-radius:999px;background:${hex};vertical-align:-2px;margin-right:6px;border:1px solid rgba(0,0,0,.2)"></span>${hex}</span>`).join('')
        + '</div>';
      metaEl.appendChild(pal);

      const note = document.createElement('div');
      note.className = 'item';
      note.textContent = notes || '—';
      metaEl.appendChild(note);
    }
  </script>
</body>
</html>
